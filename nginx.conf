worker_processes auto;

events { worker_connections 1024 }

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  sendfile on;
  keepalive_timeout 65;

  upstream astro_server {
    server 127.0.0.1:3001;
  }

  server {
    listen 80;

    # Arquivos est√°ticos do Astro
    location /_astro/ {
      alias /app/dist/client/_astro/;
      expires 30d;
      access_log off;
    }

    # Todos os assets gerados
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?|ttf|eot|otf)$ {
      root /app/dist/client;
      try_files $uri =404;
      expires 30d;
      access_log off;
    }

    # Tudo mais = passa pro Node SSR
    location / {
      proxy_pass http://astro_server;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }
  }
}
