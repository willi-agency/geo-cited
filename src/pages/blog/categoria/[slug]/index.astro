---
// src/pages/blog/categoria/[slug]/index.astro
import Layout from '../../../../layouts/Layout.astro';
import BlogArticleGrid from '@/components/ui/blog/BlogArticleGrid.astro';
import { API_URL_BLOG, API_KEY }from "../../../../config/site";

export async function getStaticPaths() {
  const POSTS_PER_PAGE = 12;
  
  // Buscar todas as categorias
  const categoriesRes = await fetch(`${API_URL_BLOG}/blog/articles/home/${API_KEY}?listCategories=true`);
  const categoriesData = await categoriesRes.json();
  const categories = categoriesData.categories || [];
  
  const paths = [];
  
  for (const category of categories) {
    // Buscar posts da página 1
    const res = await fetch(
      `${API_URL_BLOG}/blog/articles/all/${API_KEY}?taxonomy=${category.slug}&taxonomyType=category&page=1&perPage=${POSTS_PER_PAGE}`
    );
    
    if (!res.ok) continue;
    
    const data = await res.json();
    const posts = data.data || [];
    const totalPosts = data.pagination?.total || 0;
    const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE);
    
    paths.push({
      params: { slug: category.slug },
      props: {
        posts: posts,
        category: category,
        currentPage: 1,
        totalPages: totalPages,
        totalPosts: totalPosts
      }
    });
  }
  
  console.log(`✅ Categorias index: ${paths.length} páginas`);
  return paths;
}

const { posts, category, currentPage, totalPages, totalPosts } = Astro.props;

const title = `${category.name} - Categoria`;
const description = category.metaDescription || 
  `Explore ${totalPosts} artigos sobre ${category.name}. ${category.description || ''}`;
---

<Layout
  title={title}
  description={description}
  jsonLdItems={["website", "organization"]}
  canonical={`https://geocited.com.br/blog/categoria/${category.slug}`}
>
  <BlogArticleGrid
    posts={posts}
    title={category.name}
    description={category.description}
    currentPage={currentPage}
    totalPages={totalPages}
    baseUrl={`/blog/categoria/${category.slug}`}
  />
</Layout>