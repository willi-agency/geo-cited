---
// src/pages/blog/tag/[slug]/[page].astro
import Layout from '../../../../layouts/Layout.astro';
import BlogArticleGrid from '@/components/ui/blog/BlogArticleGrid.astro';
import { API_URL_BLOG, API_KEY }from "../../../../config/site";

export async function getStaticPaths() {
  const POSTS_PER_PAGE = 12;
  const API_MAX_PER_PAGE = 100;
  
  // Buscar todas as tags
  const tagsRes = await fetch(`${API_URL_BLOG}/blog/articles/home/${API_KEY}?listTags=true`);
  const tagsData = await tagsRes.json();
  const tags = tagsData.tags || [];
  
  const paths = [];
  
  for (const tag of tags) {
    // Buscar total de posts
    const firstPageRes = await fetch(
      `${API_URL_BLOG}/blog/articles/all/${API_KEY}?taxonomy=${tag.slug}&taxonomyType=tag&page=1&perPage=1`
    );
    
    if (!firstPageRes.ok) continue;
    
    const firstPageData = await firstPageRes.json();
    const totalPosts = firstPageData.pagination?.total || 0;
    const apiTotalPages = firstPageData.pagination?.totalPages || 1;
    const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE);
    
    if (totalPages <= 1) continue; // Não gerar se só tem 1 página
    
    // Buscar TODOS os posts
    let allPosts = [];
    for (let apiPage = 1; apiPage <= apiTotalPages; apiPage++) {
      const allRes = await fetch(
        `${API_URL_BLOG}/blog/articles/all/${API_KEY}?taxonomy=${tag.slug}&taxonomyType=tag&page=${apiPage}&perPage=${API_MAX_PER_PAGE}`
      );
      
      if (allRes.ok) {
        const data = await allRes.json();
        allPosts.push(...(data.data || []));
      }
    }
    
    // Gerar páginas 2, 3, 4... (página 1 é o index.astro)
    for (let page = 2; page <= totalPages; page++) {
      const startIndex = (page - 1) * POSTS_PER_PAGE;
      const endIndex = startIndex + POSTS_PER_PAGE;
      const postsForPage = allPosts.slice(startIndex, endIndex);
      
      paths.push({
        params: { 
          slug: tag.slug,
          page: String(page)
        },
        props: {
          posts: postsForPage,
          tag: tag,
          currentPage: page,
          totalPages: totalPages,
          totalPosts: totalPosts
        }
      });
    }
  }
  
  console.log(`✅ Tags paginadas: ${paths.length} páginas`);
  return paths;
}

const { posts, tag, currentPage, totalPages, totalPosts } = Astro.props;

const title = `${tag.name} - Página ${currentPage} de ${totalPages}`;
const description = tag.metaDescription || 
  `Descubra ${totalPosts} artigos marcados com ${tag.name}. ${tag.description || ''}`;
---

<Layout
  title={title}
  description={description}
  jsonLdItems={["website", "organization"]}
  currentPage={currentPage}
  totalPages={totalPages}
  baseUrl={`/blog/tag/${tag.slug}`}
>
  <BlogArticleGrid
    posts={posts}
    title={`#${tag.name}`}
    description={tag.description}
    currentPage={currentPage}
    totalPages={totalPages}
    baseUrl={`/blog/tag/${tag.slug}`}
  />
</Layout>